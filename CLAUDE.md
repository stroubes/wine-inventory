# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Server (Backend)
```bash
cd server
npm run dev      # Start development server with hot reload on port 3001
npm run build    # Compile TypeScript to JavaScript
npm run start    # Start production server
npm run migrate  # Run database migrations (uses knexfile.js)
```

### Client (Frontend)
```bash
cd client  
npm run dev      # Start Vite dev server on port 5173
npm run build    # Build for production (includes TypeScript compilation)
npm run preview  # Preview production build locally
```

### Database
```bash
# Database is SQLite located at database/wine_inventory.db
# Schema is in database/schema.sql
# Migrations are in database/migrations/ (JavaScript format)
sqlite3 database/wine_inventory.db  # Direct SQLite access
```

## Architecture Overview

### Full-Stack Separation
This is a **completely separate frontend and backend** architecture:
- **Client**: React + TypeScript + Vite on port 5173
- **Server**: Express + TypeScript on port 3001  
- **Database**: SQLite with Knex.js query builder
- **Communication**: REST API calls via Axios with automatic date transformation

### Core Domain Model
The application centers around **Wine entities** with:
- **Wine**: Core inventory item with vintage, region, rating (1-100), consumption status
- **WineImage**: Front/back label images and memory photos
- **WineMemory**: Experience tracking with ratings (1-5) and rich text
- **RackSlot**: Physical wine rack position mapping for SVG visualization
- **FoodPairing**: Manual and API-suggested wine/food combinations

### Database Architecture
- **UUID primary keys** generated by uuid library (not database auto-increment)
- **JSON fields** for arrays (grape_varieties, food_pairings, tags) stored as TEXT
- **Soft referential integrity** - foreign keys with ON DELETE CASCADE/SET NULL
- **Date handling** - stored as DATETIME strings, transformed to Date objects by API client
- **Wine ratings** use 1-100 scale, memory ratings use 1-5 scale

### Type System Strategy
- **Shared types** between client/server but maintained separately in each codebase
- **Type-only imports** required (use `import type { }`) due to verbatimModuleSyntax
- **Transformation functions** in WineModel handle JSON serialization/parsing
- **API response transformation** in client automatically converts date strings

### API Design Patterns
- **WineModel** class with static methods handles all database operations and JSON serialization
- **Route handlers** in server/src/routes/ validate input and call model methods
- **wineApi service** in client provides typed API calls with automatic date parsing
- **Error handling** with proper HTTP status codes and user-friendly messages
- **Axios interceptors** automatically transform ISO date strings to Date objects on response
- **UUID generation** using uuid library for all primary keys (not auto-increment)
- **JSON storage** for arrays (grape_varieties, food_pairings) in SQLite TEXT fields

### Frontend Architecture
- **React 18** with functional components and hooks
- **React Router** for navigation with protected routes pattern
- **Tailwind CSS v3** (not v4) with custom component classes in index.css
- **Layout component** provides responsive sidebar navigation
- **API state management** via useState/useEffect (no Redux/Zustand yet)

### Critical Requirements
1. **SVG Rack Visualization** - Must integrate provided SVG file for interactive wine rack
2. **Image Management** - Front/back labels plus memory photos with compression
3. **400-bottle capacity** - Performance optimization for large collections
4. **Mobile-first responsive** - Touch-optimized interactions required

### Database Migrations
- JavaScript files in database/migrations/ numbered sequentially
- Use `npm run migrate` from server directory
- Manual SQLite schema is in database/schema.sql for reference
- Knex configuration in server/knexfile.js points to SQLite database

### Development Workflow
1. Always start server first (`cd server && npm run dev`)
2. Then start client (`cd client && npm run dev`) 
3. Database is automatically available - no setup needed
4. API calls from client to server use environment variable VITE_API_URL (defaults to localhost:3001)

### Additional Server Commands
```bash
cd server
npm run migrate:rollback  # Rollback last migration
npm run seed             # Run database seeds (if configured)
lsof -ti:3001 | xargs kill -9  # Kill process on port 3001 if needed
```

### Wine API Dependencies
- **puppeteer**: Headless Chrome for web scraping Vivino and other wine sites
- **cheerio**: Server-side jQuery-like DOM manipulation for parsing scraped content
- **@types/cheerio**: TypeScript definitions for Cheerio

### Memory Management System
- **MemoryForm component** uses RichTextEditor for experience content
- **Memory ratings** are 1-5 scale (different from wine ratings which are 1-100)
- **Text direction issue**: RichTextEditor was converted from contentEditable to textarea to fix RTL text display problems
- **Memory API** provides stats, CRUD operations, and date formatting utilities
- **Memory photos** support through image upload system

### Image Management Architecture
- **Three image types**: front_label, back_label, memory
- **Sharp library** for server-side image processing and compression
- **Multer middleware** handles file uploads with validation
- **File storage** in server/uploads/ directory with organized structure
- **Image metadata** stored in `images` table (NOT `wine_images`) with fields: `original_name`, `size` (NOT `original_filename`, `file_size`)
- **Database schema mismatch**: Server code must use `images` table and correct field names
- **CORS configuration**: Required for cross-origin image serving between client/server ports
- **Image serving**: `/api/images/:imageId` endpoint serves files with proper CORS headers
- **Image API**: `imageApi.categorizeImages()` helper separates images by type for display

### Testing and Linting
- **Client linting**: `npm run lint` (ESLint with TypeScript rules and React hooks/refresh plugins)
- **No test suites** currently configured - testing approach needs to be determined
- **TypeScript compilation**: Strict mode enabled with verbatimModuleSyntax
- **Development tools**: nodemon for server hot reload, Vite for client hot reload
- **Build validation**: Use `npm run build` in both client and server to check TypeScript errors

### Database Migration System
- **Knex.js migrations** in database/migrations/ with both .js and .ts versions
- **Migration commands**: `npm run migrate` and `npm run migrate:rollback` from server directory
- **Database seeding**: `npm run seed` available but not currently used
- **Foreign key constraints** with CASCADE/SET NULL for data integrity

### API Response Transformation
- **Automatic date parsing**: Client axios interceptor converts date strings to Date objects
- **JSON field handling**: Arrays stored as TEXT in SQLite, parsed by WineModel transform methods
- **Error handling**: Standardized HTTP status codes with user-friendly messages
- **CORS configuration**: Enabled for cross-origin requests between client/server

### Current Implementation Status
- **Phase 1 Complete**: Basic CRUD, navigation, dashboard, wine list with filtering, memory management with clickable details
- **Phase 2 Complete**: Wine forms with region dropdown, image upload system, archived wine interaction, JM Wine Cellar branding
- **Phase 3 Complete**: Wine API/scraping integration with external wine database search and auto-population
- **Phase 4 Complete**: Wine image display in WineDetail component with categorized layout (front/back labels, memory photos)
- **TypeScript compilation** works correctly with proper type-only imports
- **Tailwind CSS** configured with forms/typography plugins and custom wine color theme
- **Memory system** fully functional with rich text editing, photo support, and dedicated detail pages
- **Archives system** fully functional with clickable wine cards and in-component detail views
- **Memory integration** enables seamless memory creation from wine views with automatic wine association
- **Image display system** fully functional with responsive grid layout, loading states, and empty states
- **Wine API integration** fully functional with Vivino scraping, data normalization, and form prefilling

### UI/UX Design System
- **Logo Component**: JM Wine Cellar branding with wine bottle SVG icon integrated throughout layout
- **Color Palette**: Wine-themed colors (wine-600: #c2185b, wine-700: #a31545) with burgundy accents
- **Typography**: Poppins for body text, Crimson Pro serif for headings
- **Component Classes**: Standardized .btn-primary, .btn-secondary, .card, .input-field utilities
- **Responsive Design**: Mobile-first approach with touch-optimized interactions

### Navigation Architecture  
- **Layout Component**: Centralized navigation with responsive sidebar/mobile drawer
- **Route Structure**: 
  - `/` → Dashboard with statistics
  - `/wines` → WineList with search/filtering  
  - `/wines/add` → AddWine form
  - `/wines/:id` → WineDetail view
  - `/wines/:id/edit` → EditWine form
  - `/memories` → MemoryManagement list
  - `/memories/add` → AddMemory form (with wine ID parameter)
  - `/memories/:id` → MemoryDetail view
  - `/rack` → RackVisualization
  - `/archives` → Archives with consumed wines

### Form Architecture
- **WineForm Component**: Shared between AddWine/EditWine with region dropdown (60+ worldwide regions including Canadian provinces)
- **MemoryForm Component**: Rich text editing with photo upload support
- **Validation Strategy**: Client-side validation with error display and server-side validation
- **File Upload**: Multi-file support for wine labels and memory photos with Sharp image processing

### Memory Integration System
- **Wine-to-Memory Flow**: "Add Memory" buttons on WineDetail and AddWine success screen
- **URL Parameter Pattern**: `/memories/add?wineId=xyz` for pre-filled wine association
- **AddMemory Component**: Dedicated form page that loads wine context and pre-fills wine_id
- **MemoryForm Component**: Handles both create and edit modes with wine_id management
- **Navigation Flow**: Wine pages → Memory form → Memory list/detail pages

### Wine API & External Data Integration
- **WineApiService**: Singleton service for external wine database integration
- **Vivino Scraping**: Real web scraping using Puppeteer and Cheerio with anti-detection measures
- **Data Normalization**: WineDataNormalizer utility standardizes regions, grape varieties, and wine classifications
- **Retry Logic**: Exponential backoff retry system (3 attempts with 1s, 2s, 4s delays)
- **Rate Limiting**: 2-second delays between requests to avoid overwhelming external services
- **Multiple Sources**: Vivino primary, Wine API fallback, extensible for additional sources
- **Duplicate Detection**: Similarity algorithms to remove duplicate results across sources
- **Form Integration**: WineSearchModal component integrates with AddWine and EditWine forms
- **Auto-Population**: Existing wines can be enriched with external data via "Enrich from Database" feature
- **Food Pairing API**: Intelligent food pairing suggestions based on wine characteristics
- **Error Handling**: Comprehensive error handling with graceful fallbacks and user-friendly messages

### Wine API Endpoints
- **GET /api/wines/search-external** - Search external wine databases (Vivino, etc.)
- **GET /api/wines/:id/food-pairings** - Get intelligent food pairing suggestions
- **POST /api/wines/:id/auto-populate** - Auto-populate wine details from external sources
- **GET /api/wines/api-stats** - Get API usage statistics and request counts

### Route Ordering Critical Note
- **Specific routes MUST come before parameterized routes** in Express
- `/search-external` and `/api-stats` must be defined before `/:id` routes
- Route conflicts will cause 404 errors if ordering is incorrect

### Data Normalization Rules
- **Region Mapping**: 60+ wine regions standardized (e.g., "napa" → "Napa Valley, California")
- **Grape Varieties**: Common aliases normalized (e.g., "shiraz" → "Syrah", "cab sauv" → "Cabernet Sauvignon")
- **Wine Color Classification**: Intelligent inference from grape varieties and wine names
- **Rating Conversion**: Vivino 5-point scale converted to 100-point scale (rating * 20)
- **Price Validation**: Prices between $1-$10,000 accepted, others filtered out
- **Vintage Validation**: Years between 1800 and current year accepted
- **Duplicate Detection**: 80% similarity threshold using Jaro-Winkler distance algorithm
- **String Normalization**: Removes extra whitespace, standardizes quotes and apostrophes

### Critical Implementation Notes
- **Database Table Names**: Use `images` table (NOT `wine_images`) in server code
- **Database Field Names**: Use `original_name`, `size`, `alt_text`, `description` (NOT `original_filename`, `file_size`, `caption`)
- **CORS Headers**: Essential for image serving - server includes explicit CORS headers for cross-origin requests
- **Image Display**: WineDetail component includes dedicated "Wine Images" section with categorized display
- **Memory Navigation**: Cards are fully clickable with dedicated detail pages (MemoryDetail.tsx)
- **Archive Interaction**: Wine cards in Archives page are clickable for in-component detail view (not separate route)
- **Region Selection**: Comprehensive dropdown including "Okanagan Valley, British Columbia" and other Canadian regions
- **Icon Spacing**: Use `h-5 w-5 mr-2` for consistent icon sizing, avoid negative margins
- **Button Styling**: .btn-primary uses wine-themed colors with generous padding (py-2.5 px-6)
- **Memory Button Integration**: WineDetail and AddWine success pages include "Add Memory" buttons that navigate with pre-filled wine context

### Common Issues and Solutions
- **500 Error on Image API**: Usually caused by table name mismatch (`wine_images` vs `images`) or field name mismatch
- **CORS Errors for Images**: Requires explicit CORS headers in server routes and helmet configuration with `crossOriginResourcePolicy: "cross-origin"`
- **Port 3001 Already in Use**: Use `lsof -ti:3001` to find process and `kill <pid>` to stop it
- **TypeScript Build Errors**: Often caused by using wrong field names in image interfaces - ensure client/server field names match database schema
- **Image Upload Failures**: Check that Sharp and Multer are properly configured and uploads directory exists
- **404 on /api/wines/search-external**: Route ordering issue - specific routes must come before `/:id` parameterized routes
- **Wine Search Modal Not Working**: Check that server is running and API endpoints are accessible on port 3001
- **Vivino Scraping Failures**: Expected due to anti-bot measures - service gracefully falls back to mock data
- **Puppeteer Crashes**: May require additional system dependencies on some platforms - check Puppeteer docs for requirements
- **Wine API Timeout Errors**: Normal for initial requests - Puppeteer needs time to launch browser instance